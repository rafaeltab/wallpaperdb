# Phase 2: Core Infrastructure

**Goal:** Set up GraphQL client, TanStack Query configuration, type definitions, and Ingestor upload client.

---

## Prerequisites

- **Phase 1 complete:** Project structure and configuration files created
- Dependencies installed (`pnpm install`)

---

## Gateway GraphQL Schema Reference

The Gateway provides a GraphQL API at `http://localhost:3000/graphql`.

**Key Query:**
- `searchWallpapers(filter: WallpaperFilter, first: Int, after: String): WallpaperConnection!`

**Key Types:**
- `Wallpaper`: wallpaperId, userId, variants[], uploadedAt, updatedAt
- `Variant`: width, height, aspectRatio, format, fileSizeBytes, url (computed), createdAt
- `WallpaperConnection`: edges[], pageInfo

**Pagination:** Cursor-based (Relay spec)

---

## Tasks

### 2.1 Create GraphQL Type Definitions

**File:** `apps/web/src/lib/graphql/types.ts`

```typescript
// Manual types matching Gateway schema (apps/gateway/src/graphql/schema.ts)

export interface Wallpaper {
  wallpaperId: string;
  userId: string;
  variants: Variant[];
  uploadedAt: string;
  updatedAt: string;
}

export interface Variant {
  width: number;
  height: number;
  aspectRatio: number;
  format: string;
  fileSizeBytes: number;
  createdAt: string;
  url: string;  // Computed by Gateway - no need to construct URLs manually
}

export interface PageInfo {
  hasNextPage: boolean;
  hasPreviousPage: boolean;
  startCursor?: string;
  endCursor?: string;
}

export interface WallpaperEdge {
  node: Wallpaper;
}

export interface WallpaperConnection {
  edges: WallpaperEdge[];
  pageInfo: PageInfo;
}

export interface WallpaperFilter {
  userId?: string;
  variants?: VariantFilter;
}

export interface VariantFilter {
  width?: number;
  height?: number;
  aspectRatio?: number;
  format?: string;
}
```

---

### 2.2 Create GraphQL Client

**File:** `apps/web/src/lib/graphql/client.ts`

```typescript
import { GraphQLClient } from 'graphql-request';

const GATEWAY_URL = import.meta.env.VITE_GATEWAY_URL || 'http://localhost:3000/graphql';

export const graphqlClient = new GraphQLClient(GATEWAY_URL, {
  headers: {
    // Future: Add auth headers
  },
});
```

---

### 2.3 Create GraphQL Queries

**File:** `apps/web/src/lib/graphql/queries.ts`

```typescript
import { gql } from 'graphql-request';

export const SEARCH_WALLPAPERS = gql`
  query SearchWallpapers(
    $filter: WallpaperFilter
    $first: Int
    $after: String
  ) {
    searchWallpapers(filter: $filter, first: $first, after: $after) {
      edges {
        node {
          wallpaperId
          userId
          uploadedAt
          updatedAt
          variants {
            width
            height
            aspectRatio
            format
            fileSizeBytes
            createdAt
            url
          }
        }
      }
      pageInfo {
        hasNextPage
        hasPreviousPage
        startCursor
        endCursor
      }
    }
  }
`;
```

---

### 2.4 Create Ingestor Upload Client

**File:** `apps/web/src/lib/api/ingestor.ts`

```typescript
const INGESTOR_URL = import.meta.env.VITE_INGESTOR_URL || 'http://localhost:3001';

export interface UploadResponse {
  wallpaperId: string;
  userId: string;
  uploadState: string;
  fileType: string;
  mimeType: string;
  fileSizeBytes: number;
  width: number;
  height: number;
  aspectRatio: number;
  uploadedAt: string;
}

export async function uploadWallpaper(file: File): Promise<UploadResponse> {
  const formData = new FormData();
  formData.append('file', file);

  const response = await fetch(`${INGESTOR_URL}/upload`, {
    method: 'POST',
    body: formData,
    // Future: Add auth headers
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail || 'Upload failed');
  }

  return response.json();
}
```

---

### 2.5 Create App Root Component with TanStack Query

**File:** `apps/web/src/App.tsx`

```typescript
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';
import { RouterProvider, createRouter } from '@tanstack/react-router';
import { routeTree } from './routeTree.gen';  // Auto-generated by TanStack Router plugin

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60,  // 1 minute - data stays fresh for 1 min
      gcTime: 1000 * 60 * 5,  // 5 minutes - cache garbage collection
      refetchOnWindowFocus: false,  // Don't refetch when window regains focus
    },
  },
});

const router = createRouter({
  routeTree,
  context: {
    queryClient,
  },
  defaultPreload: 'intent',  // Prefetch routes on hover/focus
});

// Register router type for type safety
declare module '@tanstack/react-router' {
  interface Register {
    router: typeof router;
  }
}

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <RouterProvider router={router} />
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
}

export default App;
```

---

### 2.6 Create Main Entry Point (Placeholder)

**File:** `apps/web/src/main.tsx`

```typescript
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import './index.css';

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
```

---

### 2.7 Create Global Styles

**File:** `apps/web/src/index.css`

```css
@import 'tailwindcss';

/* Global styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
    Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
```

---

## Files Created

- `apps/web/src/lib/graphql/types.ts`
- `apps/web/src/lib/graphql/client.ts`
- `apps/web/src/lib/graphql/queries.ts`
- `apps/web/src/lib/api/ingestor.ts`
- `apps/web/src/App.tsx`
- `apps/web/src/main.tsx`
- `apps/web/src/index.css`

---

## Verification

After completing this phase:

1. **Type check:** `make web-check` (should pass with no errors)
2. **Format code:** `make web-format`
3. **Lint code:** `make web-lint`

**Note:** You cannot run `make web-dev` yet because routes are not created (Phase 3).

---

## Next Phase

**Phase 3:** Routes & Components (`frontend-phase-3-routes-components.md`)
- Root layout with navigation
- Home page (browse wallpapers)
- Upload page
- HTML entry point

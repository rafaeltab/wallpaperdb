---
title: "ADR-001: Fastify over NestJS"
description: Architecture decision to continue with Fastify + TSyringe instead of migrating to NestJS.
---

**Status:** Accepted
**Date:** 2025-01-20
**Context:** Choosing framework for multi-service architecture

## Context

WallpaperDB is transitioning from a single service (ingestor) to a multi-service microservices architecture. We need to decide whether to:

1. Continue with **Fastify + TSyringe** (current stack)
2. Migrate to **NestJS** (opinionated framework)

## Decision

**We will continue with Fastify + TSyringe and NOT migrate to NestJS.**

## Rationale

### Current Stack Analysis

**Ingestor Service (completed):**
- 32 TypeScript files, ~3,500 LOC
- Excellent architecture:
  - BaseConnection pattern (reusable)
  - TSyringe DI (clean, testable)
  - TesterBuilder pattern (exceptional test infrastructure)
  - State machine pattern
  - RFC 7807 error handling

**What's Already Reusable:**
- BaseConnection pattern (90%+ reusable)
- All connection managers (100% copy-paste ready)
- Error handling (100% reusable)
- Test infrastructure (TesterBuilder - better than NestJS Test module)
- OTEL setup (100% reusable)

### NestJS Migration Cost-Benefit

**Migration Cost:**
- 4-6 weeks to migrate ingestor
- Learning curve for team
- Risk of regression bugs
- Framework lock-in

**Benefits:**
- ~100 lines less boilerplate per service
- Auto-generated Swagger docs
- Larger community

**ROI Calculation:**
- **Fastify Path:** 2 weeks (shared packages) + 1 week (Service #2) = 3 weeks to Service #2
- **NestJS Path:** 4-6 weeks (migration) + 1 week (Service #2) = 5-7 weeks to Service #2
- **Savings:** 2-4 weeks by staying with Fastify

## Alternatives Considered

### NestJS
**Pros:** More opinionated, larger community, auto Swagger
**Cons:** 4-6 week migration, less flexible, framework lock-in
**Verdict:** Cost > Benefit at current scale

### tRPC
**Pros:** End-to-end type safety
**Cons:** Not designed for microservices, no built-in DI
**Verdict:** Better for monoliths with TypeScript clients

### Hono
**Pros:** Modern, fast
**Cons:** Minimal framework (same boilerplate issues)
**Verdict:** No significant advantage

## Consequences

### Positive

- **Fast Time to Service #2:** 3 weeks vs 5-7 weeks
- **Preserved Investment:** All current work remains valuable
- **Flexibility:** Can optimize each service independently
- **Performance:** Fastest possible Node.js stack
- **Test Infrastructure:** Keep exceptional TesterBuilder pattern
- **Future Options:** Can migrate to NestJS later if needed

### Negative

- **Manual Boilerplate:** ~100 lines per service (vs ~50 with NestJS)
- **No Auto Swagger:** Need to add manually
- **Less Prescriptive:** Requires discipline for consistency
- **Smaller Community:** Fastify + TSyringe has smaller community

### Mitigation

- **Boilerplate:** Shared packages + template generator reduce to ~100 lines
- **Swagger:** Can add `@fastify/swagger` if needed
- **Consistency:** Strong documentation and code review

## When to Reconsider

Revisit this decision if:

1. **Team grows beyond 5 developers** - Standardization becomes critical
2. **Building 10+ services** - Boilerplate becomes painful
3. **Complex patterns emerge** - Need CQRS, event sourcing, sagas
4. **Hiring is difficult** - NestJS has larger talent pool

## Migration Path (if needed later)

**Most work transfers:**
- Shared package logic wraps into NestJS modules
- Business logic is framework-agnostic
- Test infrastructure (TesterBuilder) still works

**What changes:**
- Route handlers → Controllers
- TSyringe DI → NestJS DI
- Manual registration → Module decorators

**Estimated effort:** 2-3 weeks per service

---
title: Grafana LGTM Stack
description: All-in-one observability with Grafana, Loki, Tempo, and Mimir
---

The Grafana LGTM stack provides complete observability for WallpaperDB with logs, metrics, traces, and dashboards in a single container.

## Quick Reference

- **Grafana**: http://localhost:3000 (admin/admin)
- **OTLP gRPC**: localhost:4317
- **OTLP HTTP**: http://localhost:4318
- **Components**: Loki (logs), Grafana (dashboards), Tempo (traces), Mimir (metrics)

## Access

**Grafana UI:**
- URL: http://localhost:3000
- Username: `admin`
- Password: `admin` (change on first login)

**OTLP Endpoints:**
Services send telemetry to these endpoints:

```typescript
const otel = new OtelConnection({
  otelEndpoint: 'http://localhost:4318',  // HTTP endpoint
  otelServiceName: 'my-service'
});
```

## Components

### Grafana
Dashboard and visualization platform.

**Pre-configured data sources:**
- Loki (logs)
- Tempo (traces)
- Mimir/Prometheus (metrics)

**Available dashboards:**
- Media Service Dashboard (custom)
- Future: Ingestor Dashboard, System Overview

### Loki
Log aggregation and querying.

**Query logs:**
1. Navigate to **Explore**
2. Select **Loki** data source
3. Use LogQL queries:

```text
{service_name="wallpaperdb-ingestor"} |= "error"
```

### Tempo
Distributed tracing backend.

**View traces:**
1. Navigate to **Explore**
2. Select **Tempo** data source
3. Search by trace ID or service

**Linked from logs:**
Logs automatically link to traces via trace ID.

### Mimir
Prometheus-compatible metrics storage.

**Query metrics:**
1. Navigate to **Explore**
2. Select **Mimir** data source
3. Use PromQL queries:

```text
rate(uploads_total[5m])
```

## Custom Dashboards

Dashboards are provisioned from `/infra/grafana/dashboards/`.

**Media Service Dashboard:**
- File: `media-service-dashboard.json`
- Metrics: Retrieval rates, resize operations, cache hits
- URL: http://localhost:3000/d/media-service

**Adding new dashboards:**
1. Create JSON file in `/infra/grafana/dashboards/`
2. Restart Grafana: `docker compose restart lgtm`
3. Dashboard auto-loads on startup

## Telemetry Integration

Services use `@wallpaperdb/core/telemetry` for instrumentation:

**Traces:**
```typescript
import { withSpan } from "@wallpaperdb/core/telemetry";

await withSpan("operation.name", { userId: "123" }, async (span) => {
  // Operation code...
  span.setAttribute("custom.attr", "value");
  return result;
});
```

**Metrics:**
```typescript
import { recordCounter, recordHistogram } from "@wallpaperdb/core/telemetry";

recordCounter("uploads.total", 1, { status: "success" });
recordHistogram("upload.duration_ms", durationMs, { fileType: "image" });
```

**Automatic instrumentation:**
- HTTP requests (Fastify)
- Database queries (PostgreSQL)
- NATS messages
- S3 operations

## Viewing Data

### Traces
1. Open http://localhost:3000
2. Navigate to **Explore** → **Tempo**
3. Search by:
   - Service name (e.g., `wallpaperdb-ingestor`)
   - Span name (e.g., `upload.process`)
   - Duration (e.g., `> 1s`)
   - Tags (e.g., `http.status_code=500`)

### Metrics
1. Navigate to **Explore** → **Mimir**
2. Query examples:

```text
# Request rate
rate(http_requests_total[5m])

# Error rate
rate(http_requests_total{status="error"}[5m]) /
rate(http_requests_total[5m])

# P95 latency
histogram_quantile(0.95,
  rate(http_request_duration_seconds_bucket[5m])
)
```

### Logs
1. Navigate to **Explore** → **Loki**
2. Query examples:

```text
# All logs for a service
{service_name="wallpaperdb-ingestor"}

# Errors only
{service_name="wallpaperdb-ingestor"} |= "error"

# By trace ID
{service_name="wallpaperdb-ingestor"} | json | trace_id="abc123..."
```

### Correlation
Logs, metrics, and traces are automatically correlated:

- **Logs → Traces**: Click trace ID in log to view trace
- **Traces → Logs**: Click "Logs for this span" to view related logs
- **Metrics → Traces**: Use exemplars to jump from metric to trace

## Data Retention

**Default retention:**
- Logs (Loki): 30 days
- Metrics (Mimir): 15 days
- Traces (Tempo): 7 days

**Volume:**
- All data stored in `lgtm-data` Docker volume

**Clear data:**
```bash
docker volume rm wallpaperdb-lgtm-data
make infra-start  # Recreates volume
```

## Performance Tips

**Reduce data volume:**
1. **Sample traces**: Sample 10% of requests in production
2. **Filter logs**: Only send WARN and ERROR levels
3. **Aggregate metrics**: Use histograms instead of raw values

**Configuration:**
```typescript
// In service config
const shouldSample = Math.random() < 0.1;  // 10% sampling

if (shouldSample || statusCode >= 400) {
  // Send trace
}
```

## Troubleshooting

**No data appearing:**
1. Check service is sending to correct endpoint (localhost:4318)
2. Verify OTLP connection initialized
3. Check Grafana data source configuration (should be pre-configured)

**Slow dashboard loading:**
1. Reduce time range (default: last 6 hours)
2. Add query filters
3. Increase LGTM container memory

## Related Documentation

- [Observability](/docs/observability) - Complete observability guide
- [Package: Core](/docs/packages/core) - Telemetry utilities
- [Services: Ingestor](/docs/services/ingestor) - Service observability examples
